// Copyright 2025 Velda Inc
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
syntax = "proto3";

package velda.config;

import "agent/config.proto";
import "google/protobuf/duration.proto";

option go_package = "velda.io/velda/pkg/proto/config";

message Server {
  // Local address for the server to listen on.
  string grpc_address = 1;
  string http_address = 2;

  reserved 3, 4, 5;
  reserved 64 to 127;
}

message Storage {
  // ZFS storage configuration.
  message Zfs {
    string pool = 1;

    // If `max_disk_size_gb` is set (non-zero),
    // created instance datasets will have `refquota` set to this value.
    int64 max_disk_size_gb = 2;
  }
  message MiniVelda { string root = 1; }
  oneof storage {
    Zfs zfs = 1;
    MiniVelda mini = 4;
  }
  reserved 2, 3;
}

message PoolMetadata { string description = 1; }

message TailscaleConfig {
  // Tailscale control server URL
  string server = 1;

  // Pre-authentication key for joining the tailnet
  string pre_auth_key = 2;
}

message AgentPool {
  string name = 1;

  message AutoScaler {
    AutoscalerBackend backend = 1;
    int32 max_agents = 2;
    int32 min_idle_agents = 3;
    int32 max_idle_agents = 4;

    // Minimum number of agents to keep in the pool (hard lower bound).
    // This ensures the autoscaler will not scale the total number of agents
    // below this value. Default is 0.
    int32 min_agents = 12;

    // How long to wait before removing idle agents.
    // Default will be 0 seconds: it will immediately remove idle agents
    // until min_idle_agents is reached.
    google.protobuf.Duration idle_decay = 5;

    // How long to wait before starting the size-maintenance loop.
    // It will always start after all workers are connected.
    // Default to infinite: will always wait for all workers to connect.
    google.protobuf.Duration initial_delay = 6;

    // How often to scan the backend to check
    // for consistency of the agent connected VS the auto-scaler backend.
    // Default to 60 seconds.
    google.protobuf.Duration sync_loop_interval = 7;

    // If set, any worker that has not been connected to the agent
    // for this duration will be killed.
    // Only checked at every sync_loop_interval.
    google.protobuf.Duration kill_unknown_after = 8;

    // Number of sessions per agent
    // Default to 1
    // This is only used for auto-scaling purpose.
    // An agent may run less sessions than this.
    int32 default_slots_per_agent = 9;

    enum Mode {
      MODE_UNSPECIFIED = 0;
      // Standard mode: Request worker one-by-one.
      MODE_STANDARD = 1;
      // Batch mode: Request workers for all shards in a single request, and
      // nodes will be immediately shut-down after the job is completed.
      //
      // This is used to request nodes with special relationship requirement,
      // e.g.  affinity, or topology proximity requirements.
      // The actual implementation may vary depending on the underlying
      // backend.
      //
      // In batch mode, the pool name is pool:label
      MODE_BATCH = 2;
    }
    Mode mode = 10;

    // Metadata about the pool.
    PoolMetadata metadata = 11;
  }
  AutoScaler auto_scaler = 2;
}

message AutoscalerBackendGCEInstanceGroup {
  string project = 1;
  string zone = 2;
  string instance_group = 3;
  // The prefix of the instance name.
  // If not set, will use instance_group as the prefix.
  string instance_name_prefix = 4;
}

message AutoscalerBackendAWSLaunchTemplate {
  string region = 1;
  // If not set, will create the template from scratch.
  string launch_template_name = 2;
  // The prefix of the instance name.
  // If not set, will use launch_template_name as the prefix.
  string instance_name_prefix = 3;
  // If set, will use instance ID as the name.
  // Otherwise, it will use Name tag as the name.
  bool use_instance_id_as_name = 4;

  // Override some customizations for the launch template.
  string instance_type = 5;

  // Inject setup script to the instance to configure the agent.
  string agent_config_content = 6;
  // Structured version of the agent config.
  // If both agent_config and agent_config_content are set,
  // agent_config will be used.
  // Pool & broker info will be automatically set.
  velda.agent.AgentConfig agent_config = 12;

  // Restrict to a specific availability zone.
  string zone = 7;

  // The subnet ID to launch the instance in.
  string subnet_id = 8;

  // Additional tags to add to the instance.
  // If set, this will also be used to identify instances launched by the pool.
  map<string, string> tags = 9;

  // AMI ID
  string ami_id = 10;

  // Security group ids to attach to the instance.
  // If not set, will use the default from launch template.
  repeated string security_group_ids = 11;

  // How many instances to keep in stopped state for faster starting.
  int32 max_stopped_instances = 13;

  // The max duration to keep an instance stopped for reuse.
  google.protobuf.Duration max_instance_lifetime = 14;
}

message AutoscalerBackendNebiusLaunchTemplate {
  // Parent ID (e.g., project or folder ID)
  string parent_id = 1;

  // The prefix of the instance name.
  // If not set, will use instance_template_name as the prefix.
  string instance_name_prefix = 2;

  // Platform type (e.g., "gpu-h200-hxm")
  string platform = 3;

  // Instance resource preset (e.g., "1gpu-16vcpu-200gb")
  string resource_preset = 4;

  // Structured version of the agent config.
  // If both agent_config and agent_config_content are set,
  // agent_config will be used.
  // Pool & broker info will be automatically set.
  string agent_config_content = 5;
  velda.agent.AgentConfig agent_config = 6;

  // Subnet ID to launch the instance in.
  string subnet_id = 7;

  // Boot disk size in GB (default: 40)
  int64 boot_disk_size_gb = 8;

  // Whether to make instance preemptible (cheaper but can be stopped)
  bool preemptible = 9;

  // Whether to use public IP address for the instance.
  bool use_public_ip = 10;

  // Additional labels to add to the instance.
  map<string, string> labels = 11;

  // SSH public key for admin access.
  string admin_ssh_key = 12;

  // If set, will override the agent version to install.
  // Default to the current version of controller.
  string agent_version_override = 13;

  // Maximum number of disks to keep in the pool for reuse.
  // When this limit is reached, disks will be deleted instead of pooled.
  // Default: 0 (no disk pooling)
  int32 max_disk_pool_size = 14;

  // Tailscale configuration for the instance
  TailscaleConfig tailscale_config = 15;
}

message AutoscalerBackendKubernetes {
  string kubeconfig = 1;
  string context = 2;
  string pod_template_path = 3;
  string pod_selector = 4;
}

message AutoscalerBackendCommand {
  string start = 1;
  string stop = 2;
  string list = 3;
  string batch_start = 4;
}

message Provisioner {
  oneof provisioner {
    // GCEProvisioner gce = 1;
    AWSProvisioner aws = 2;
    KubernetesProvisioner kubernetes = 3;
    GCSProvisioner gcs = 4;
    AWSAutoProvisioner aws_auto = 5;
    NebiusAutoProvisioner nebius_auto = 6;
    MithrilAutoProvisioner mithril_auto = 7;
    DigitalOceanAutoProvisioner digitalocean_auto = 8;
  }
}

message KubernetesProvisioner {
  // Use in-cluster AgentPool custom resource definition or default cluster.
  // TODO: Should always use the namespace that apiserver runs.
  string namespace = 1;

  message GoogleKubernetesEngine {
    string project = 1;
    string location = 2;
    string cluster_name = 3;
  }

  // How to fetch the cluster credential.
  // If not set, will default to default config used in kubectl.
  oneof cluster { GoogleKubernetesEngine gke = 2; }
}

// Use AWS SSM parameter to provision agent pools.
message AWSProvisioner {
  string region = 1;
  string config_prefix = 2;
  google.protobuf.Duration update_interval = 3;
}

// Generate pools based on all available instance types in a region/zone.
message AWSAutoProvisioner {
  // The template for the instance spec.
  AutoscalerBackendAWSLaunchTemplate template = 1;

  // The prefix of pool names.
  string pool_prefix = 2;

  // Autoscaler config.
  // backend will be automatically generated.
  AgentPool.AutoScaler autoscaler_config = 3;

  // Allowed instance type prefixes.
  // If set, will only create pools for instance types that match
  // these prefixes.
  // If not set, will create pools for all available instance types.
  repeated string instance_type_prefixes = 4;

  // AMI Name to lookup.
  // If not set, will use the standard pattern by build version.
  string ami_name = 5;

  // The AWS account ID of the owner of the AMI.
  // If not set, will default to Velda's cloud account.
  string ami_owner = 6;

  // If set, will skip the lookup and directly use the provided AMI.
  string ami_id = 7;
}

// Generate pools based on a list of pool configurations.
message NebiusAutoProvisioner {
  // Common configuration shared across all pools

  // Parent ID (e.g., project or folder ID)
  string parent_id = 1;

  // Subnet ID to launch instances in
  string subnet_id = 2;

  // Whether to use public IP addresses for instances
  bool use_public_ip = 3;

  // Boot disk size in GB (default: 40)
  int64 boot_disk_size_gb = 4;

  // Additional labels to add to all instances
  map<string, string> labels = 5;

  // SSH public key for admin access
  string admin_ssh_key = 6;

  // If set, will override the agent version to install
  string agent_version_override = 7;

  // Default autoscaler config for all pools
  // backend will be automatically generated per pool
  AgentPool.AutoScaler autoscaler_config = 8;

  // Array of pool-specific details
  message PoolDetail {
    // Pool name (will be used as the pool name)
    string pool_name = 1;

    // Platform type (e.g., "gpu-h200-hxm")
    string platform = 2;

    // Instance resource preset (e.g., "1gpu-16vcpu-200gb")
    string resource_preset = 3;

    // Whether to make instance preemptible
    bool preemptible = 4;

    // Optional: description for the pool. If set, overrides the description in
    // autoscaler.
    string description = 6;

    // Optional: override autoscaler config for this pool
    AgentPool.AutoScaler autoscaler_config = 5;
  }

  repeated PoolDetail pool_details = 9;

  int32 max_disk_pool_size = 10;

  // Tailscale configuration for all instances
  TailscaleConfig tailscale_config = 11;
}

message AutoscalerBackendMithrilSpotBid {
  // Instance type (e.g., "8xh100", "a100", "8xa100")
  string instance_type = 1;

  // Region to launch the instance in (e.g., "us-west-2")
  string region = 2;

  // Limit price per GPU-hour in dollars
  // The spot bid will be allocated when spot price is below this limit
  double limit_price = 3;

  // Structured version of the agent config.
  // If both agent_config and agent_config_content are set,
  // agent_config will be used.
  // Pool & broker info will be automatically set.
  string agent_config_content = 4;
  velda.agent.AgentConfig agent_config = 5;

  // Additional labels/tags to add to the instance.
  map<string, string> labels = 6;

  // SSH key ID(s) to use for accessing instances
  // These must be pre-configured in the Mithril project
  repeated string ssh_key_ids = 7;

  // If set, will override the agent version to install.
  // Default to the current version of controller.
  string agent_version_override = 8;

  // Optional startup script to run on instance initialization
  string startup_script = 9;

  // Project ID in Mithril
  string project_id = 10;

  // API token for authentication
  // Should be set via environment variable MITHRIL_API_TOKEN
  string api_token = 11;

  // Optional: API endpoint override (default: api.mithril.ai)
  string api_endpoint = 12;

  // Maximum number of suspended (paused) bids to keep in the pool for reuse.
  // This help reduce start-up time.
  // When this limit is reached, bids will be terminated instead of paused.
  // Default: 0 (no bid pooling)
  int32 max_suspended_bids = 13;

  // Optional: Tailscale configuration for instance network connectivity
  // If provided, Tailscale will be installed and authenticated during instance
  // startup
  TailscaleConfig tailscale_config = 14;

  // Optional: amount of memory in GB to request for the instance
  int32 memory_gb = 15;
}

message AutoscalerBackendDigitalOceanDroplet {
  // Droplet name
  string name = 1;

  // Region to launch the droplet in (e.g., "atl1", "nyc1", "sfo3")
  string region = 2;

  // Size/tier of the droplet (e.g., "gpu-mi300x1-192gb-devcloud",
  // "s-1vcpu-1gb")
  string size = 3;

  // Image to use for the droplet (e.g., "amd-rocm71software",
  // "ubuntu-20-04-x64")
  string image = 4;

  // SSH key IDs to use for accessing droplets
  // These must be pre-configured in your DigitalOcean account
  repeated int32 ssh_key_ids = 5;

  // Enable automated backups
  bool backups = 6;

  // Enable IPv6 networking
  bool ipv6 = 7;

  // Enable monitoring
  bool monitoring = 8;

  // Tags to apply to the droplet
  repeated string tags = 9;

  // VPC UUID to attach the droplet to
  string vpc_uuid = 10;

  // Structured version of the agent config.
  // If both agent_config and agent_config_content are set,
  // agent_config will be used.
  // Pool & broker info will be automatically set.
  string agent_config_content = 11;
  velda.agent.AgentConfig agent_config = 12;

  // Additional labels/tags to add to the droplet.
  map<string, string> labels = 13;

  // If set, will override the agent version to install.
  // Default to the current version of controller.
  string agent_version_override = 14;

  // API token for authentication
  // Should be set via environment variable DIGITALOCEAN_API_TOKEN
  string api_token = 15;

  // Optional: API endpoint override (default: https://api-amd.digitalocean.com)
  string api_endpoint = 16;

  TailscaleConfig tailscale_config = 17;
}

message MithrilAutoProvisioner {
  // Common configuration shared across all pools

  // Project ID in Mithril
  string project_id = 1;

  // Region to launch instances in
  string region = 2;

  // API token for authentication
  string api_token = 3;

  // SSH key IDs to use for all instances
  repeated string ssh_key_ids = 4;

  // Additional labels to add to all instances
  map<string, string> labels = 5;

  // If set, will override the agent version to install
  string agent_version_override = 6;

  // Default autoscaler config for all pools
  // backend will be automatically generated per pool
  AgentPool.AutoScaler autoscaler_config = 7;

  // Optional: API endpoint override
  string api_endpoint = 8;

  // Array of pool-specific details
  message PoolDetail {
    // Pool name
    string pool_name = 1;

    // Instance type (e.g., "it_RrgkIZz6c9BZu5gi")
    string instance_type = 2;

    // Limit price per GPU-hour in dollars
    double limit_price = 3;

    // Optional: amount of memory in GB to request for the instance
    int32 memory_gb = 6;

    // Optional: description for the pool
    string description = 4;

    // Optional: override autoscaler config for this pool
    AgentPool.AutoScaler autoscaler_config = 5;
  }

  repeated PoolDetail pool_details = 9;

  // Maximum number of suspended (paused) bids to keep in the pool for reuse.
  int32 max_suspended_bids = 10;

  // Optional: Tailscale configuration for all instances
  TailscaleConfig tailscale_config = 11;
}

message DigitalOceanAutoProvisioner {
  // Common configuration shared across all pools

  // Region to launch droplets in (e.g., "atl1", "nyc1", "sfo3")
  string region = 1;

  // API token for authentication
  string api_token = 2;

  // SSH key IDs to use for all droplets
  repeated int32 ssh_key_ids = 3;

  // Additional labels to add to all droplets
  map<string, string> labels = 4;

  // If set, will override the agent version to install
  string agent_version_override = 5;

  // Default autoscaler config for all pools
  // backend will be automatically generated per pool
  AgentPool.AutoScaler autoscaler_config = 6;

  // Optional: API endpoint override
  string api_endpoint = 7;

  // Array of pool-specific details
  message PoolDetail {
    // Pool name
    string pool_name = 1;

    // Size/tier of the droplet (e.g., "gpu-mi300x1-192gb-devcloud")
    string size = 2;

    // Image to use (e.g., "amd-rocm71software")
    string image = 3;

    // Optional: description for the pool
    string description = 4;

    // Optional: override autoscaler config for this pool
    AgentPool.AutoScaler autoscaler_config = 5;

    // Optional: Enable backups
    bool backups = 6;

    // Optional: Enable IPv6
    bool ipv6 = 7;

    // Optional: Enable monitoring
    bool monitoring = 8;

    // Optional: VPC UUID
    string vpc_uuid = 9;
  }

  repeated PoolDetail pool_details = 8;

  // Optional: Tailscale configuration for all droplets
  TailscaleConfig tailscale_config = 9;
}

message GCSProvisioner {
  string bucket = 1;
  string config_prefix = 2;
  google.protobuf.Duration update_interval = 3;
}

message AutoscalerBackend {
  oneof backend {
    AutoscalerBackendGCEInstanceGroup gce_instance_group = 1;
    AutoscalerBackendAWSLaunchTemplate aws_launch_template = 4;
    AutoscalerBackendNebiusLaunchTemplate nebius_launch_template = 5;
    AutoscalerBackendMithrilSpotBid mithril_spot_bid = 6;
    AutoscalerBackendDigitalOceanDroplet digitalocean_droplet = 7;
    AutoscalerBackendKubernetes kubernetes = 2;
    AutoscalerBackendCommand command = 3;
  }
}

message Config {
  Server server = 1;

  Storage storage = 4;

  repeated AgentPool agent_pools = 5;

  // Dyanmic create agent pools from external configs.
  repeated Provisioner provisioners = 9;

  // Whether to allow pools to be dynamically created(e.g. through
  // custom method to create an agent).
  bool allow_new_pool = 6;

  // The default broker info to use if not set in the agent config.
  velda.agent.BrokerInfo default_broker_info = 11;

  reserved 2, 3, 7, 8, 10;
  reserved 50 to 59;
  // Note: fields 60, 61 are reserved for region config in enterprise version
  reserved 60, 61;
}
